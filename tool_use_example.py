from control_toolbox.tools.information import get_fmu_names, get_model_description, get_all_model_descriptions
from control_toolbox.tools.simulation import simulate, simulate_step_response, simulate_impulse_response, SimulationProps
from control_toolbox.tools.signals import (
    generate_step,
    StepProps, TimeRange,
    generate_impulse,
    ImpulseProps
    )
from control_toolbox.tools.analysis import (
    find_characteristic_points,
    find_peaks,
    FindPeaksProps,
    SettlingTimeProps,
    find_settling_time,
    FirstCrossingProps,
    get_first_crossing,
    InflectionPointProps,
    get_inflection_point
    )

########################################################
# INFORMATION TOOLS
########################################################
# get model names
model_names = get_fmu_names()
print(80*"=")
print("Model Names:")
print(model_names.model_dump_json(indent=2))
print(80*"=")

# get model description
model_description = get_model_description(model_names.payload[0])
print(80*"=")
print("Model Description:")
print(model_description.model_dump_json(indent=2))
print(80*"=")

# get all model descriptions
all_model_descriptions = get_all_model_descriptions()
print(80*"=")
print("All Model Descriptions:")
print(all_model_descriptions.model_dump_json(indent=2))
print(80*"=")
########################################################
# TIMESETIES TOOLS
########################################################
step_props = StepProps(
    signal_name="input",
    time_range=TimeRange(start=0.0, stop=2.0, sampling_time=0.1),
    step_time=1.0,
    initial_value=0.0,
    final_value=1.0
)
step_results = generate_step(step_props)
print(80*"=")
print("Step Results:")
print(step_results.model_dump_json(indent=2))
print(80*"=")

# impulse
impulse_props = ImpulseProps(
    signal_name="input",
    time_range=TimeRange(start=0.0, stop=30.0, sampling_time=0.1),
    impulse_time=0.0,
    magnitude=1.0
)
impulse_results = generate_impulse(impulse_props)
print(80*"=")
print("Impulse Results:")
print(impulse_results.model_dump_json(indent=2))

########################################################
# SIMULATION TOOLS
########################################################
# Create simulation properties
simulation_props = SimulationProps(
        fmu_name="PI_FOPDT",
        start_time=0.0,
        stop_time=30.0,
        output_interval=0.1,
        start_values={
            "mode": False,
            "Kp": 1.0,
            "Ti": 1.0,
        }
    )

# simulate step response
step_response = simulate_step_response(sim_props=simulation_props, step_props=step_props)

print(80*"=")
print("Simulated Step Response:")
print(step_response.model_dump_json(indent=2))
print(80*"=")

# simulate impulse response
# impulse_response = simulate_impulse_response(sim_props=simulation_props, impulse_props=impulse_props)

# print(80*"=")
# print("Simulated Impulse Response:")
# print(impulse_response.model_dump_json(indent=2))
# print(80*"=")

########################################################
# ANALYSIS TOOLS
########################################################
peak_props = FindPeaksProps()

characteristic_points = find_characteristic_points(step_response.data)
print(80*"=")
print("Characteristic Points:")
print(characteristic_points.model_dump_json(indent=2))
print(80*"=")

peaks = find_peaks(data=step_response.data, props=peak_props)
print(80*"=")
print("Peaks:")
print(peaks.model_dump_json(indent=2))
print(80*"=")

settling_time_props = SettlingTimeProps(tolerance=0.02)

settling_time = find_settling_time(step_response.data, props=settling_time_props)
print(80*"=")
print("Settling Time:")
print(settling_time.model_dump_json(indent=2))
print(80*"=")

y_max = step_response.data.signals[0].values[-1]
first_crossing_props = FirstCrossingProps(signal_name="y", threshold=0.63 * y_max)
first_crossing = get_first_crossing(step_response.data, props=first_crossing_props)
print(80*"=")
print("First Crossing:")
print(first_crossing.model_dump_json(indent=2))
print(80*"=")

inflection_point_props = InflectionPointProps(signal_name="y")
inflection_point = get_inflection_point(step_response.data, props=inflection_point_props)
print(80*"=")
print("Inflection Point:")
print(inflection_point.model_dump_json(indent=2))
print(80*"=")

